 {% extends "base.html" %}
 {% block title %}Send Brian a Message{% endblock title %}
 {% block body_content %}

  <div class="container text-center mb-4">
    <h2>Send Brian a message on his Tidbyt.</h2>
  </div>
  <div class="container mb-5">
    <div class="row justify-content-center">
      <div class="col-4">
        <!-- <form method="post" action="javascript:clickSubmit();" onsubmit="submitForm(event, this)" id="message-form"> -->
        <form method="post" id="message-form">

          <div class="mb-3">
            <label for="MESSAGE_TEXT" class="form-label">Message Text</label>
            <textarea name="MESSAGE_TEXT" maxlength=100 class="form-control"
              placeholder="Type your message here."></textarea>
          </div>

          <div class="mb-3">
            <label for="HEX_COLOR" class="form-label">Font Color</label>
            <input type="color" id="HEX_COLOR" name="HEX_COLOR" value="#ad97ef" class="form-control form-control-color">
          </div>

          <div class="mb-3">
            <div class="form-label">
              <label for="SCROLL_SPEED" class="form-label">Scroll Speed</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="SCROLL_SPEED" id="scrollSpeed1" value="250">
              <label class="form-check-label" for="scrollSpeed1">slow</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="SCROLL_SPEED" id="scrollSpeed2" value="125" checked>
              <label class="form-check-label" for="scrollSpeed2">medium</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="SCROLL_SPEED" id="scrollSpeed3" value="0">
              <label class="form-check-label" for="scrollSpeed3">fast</label>
            </div>
          </div>

          <div class="mb-3">
            <label for="FONT" class="form-label">Font</label>
            <select name="FONT" id="FONT" maxlength=100 class="form-select">
              <option value="6x13" selected="selected">6x13</option>
              <option value="tb-8">tb-8</option>
              <option value="Dina_r400-6">Dina_r400-6</option>
              <option value="5x8">5x8</option>
              <option value="10x20">10x20</option>
              <option value="tom-thumb">tom-thumb</option>
              <option value="CG-pixel-3x5-mono">CG-pixel-3x5-mono</option>
              <option value="CG-pixel-4x5-mono">CG-pixel-4x5-mono</option>
            </select>
            <div class="form-text"><a href="https://github.com/tidbyt/pixlet/blob/main/docs/fonts.md">Font Examples</a>
            </div>
          </div>

          <div class="row justify-content-center">
            <div class="col-auto">
          <button id="submit-button" type="submit" class="btn btn-primary">
            <span id="submit-button-span" style="display: none" class="spinner-grow spinner-grow-sm" role="status"
              aria-hidden="true"></span>
            Send Message
          </button>
          </div>
          </div>
          <div class="row justify-content-center">
          <div class="col-auto" id="message-response-div">
          </div>
          </div>

        </form>
      </div>
    </div>

  </div>
  <div class="container">
    <div class="row justify-content-center" id="stop_button">
      <div class="col-auto">
        <h2>Other Tidbyt actions:</h2>
      </div>
      <div class="col-auto">
        <button onclick="sendStop()" type="button" class="btn btn-danger">Tell Brian to stop talking.</button>
      </div>
    </div>

    <div class="row justify-content-center" id="response_messages"></div>
  </div>

  <script>
    function removeAllChildNodes(parent) {
      while (parent.firstChild) {
          parent.removeChild(parent.firstChild);
      }
    }

    //sends the stop api request and displays the returned text
    const sendStop = async () => {
      const response = await fetch("https://api.brianwtracey.com/stop");
      const myJson = await response.json();
      const responseDiv = document.getElementById("response_messages");
      removeAllChildNodes(responseDiv);
      const newContent = document.createTextNode(myJson);
      responseDiv.appendChild(newContent);

      console.log("json response:");
      console.log(myJson);
    }

    // toggle button
    async function toggleButton() {
      const btn = document.getElementById("submit-button");
      const btnSpan = document.getElementById("submit-button-span");

      const btnContent = btn.textContent.toLowerCase();

      if (btnContent.includes("send message")) {
        btn.setAttribute("disabled", "");
        btnSpan.removeAttribute("style");
        const inner = btn.getInnerHTML();
        const newInner = inner.replace("Send Message", "Sending...");
        btn.innerHTML = newInner;
      } else if (btnContent.includes("sending...")) {
        btn.removeAttribute("disabled");
        btnSpan.setAttribute("style", "display: none");
        const inner = btn.getInnerHTML();
        const newInner = inner.replace("Sending...", "Send Message");
        btn.innerHTML = newInner;
      }

    }

    const form = document.getElementById("message-form");
    form.addEventListener("submit", (event) => {
      event.preventDefault();
      await toggleButton();
      const resp = await fetch("https://api.brianwtracey.com/message", {
        method: 'post',
        body: new URLSearchParams(new FormData(form))
      });
      const respJson = await resp.json();
      const responseDiv = document.getElementById("message-response-div");
      const responseMessage = respJson?.status == "success" ? "Message sent!" : "Failed to send message.";
      const newContent = document.createTextNode(responseMessage);
      removeAllChildNodes(responseDiv);
      responseDiv.appendChild(newContent);

      form.reset();
      await toggleButton();
    });

    // custom form submit logic
    // const submitForm = async (e, form) => {
    //   await toggleButton();
    //   const resp = await fetch("https://api.brianwtracey.com/message", {
    //     method: 'post',
    //     body: new URLSearchParams(new FormData(form))
    //   });
    //   const respJson = await resp.json();
    //   const responseDiv = document.getElementById("message-response-div");
    //   const responseMessage = respJson?.status == "success" ? "Message sent!" : "Failed to send message.";
    //   const newContent = document.createTextNode(responseMessage);
    //   removeAllChildNodes(responseDiv);
    //   responseDiv.appendChild(newContent);

    //   document.getElementById("message-form").reset();
    //   await toggleButton();
    //   e.preventDefault();
    // };

    // const clickSubmit = async () => {
    //   //await toggleButton();
    //   document.getElementById("message-form").submit();
    // };
  </script>
 {% endblock body_content %}
